# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1

policies:
  - uid: email-security-policy-spf
    name: Email Security Policy (SPF)
    version: 0.1.0
    license: BUSL-1.1
    tags:
      mondoo.com/category: security
      mondoo.com/platform: dns
    authors:
      - name: Ben Rockwood
        email: ben@mondoo.com
    docs:
      desc: |
        ## Overview

        This policy bundle checks for best practices and common misconfigurations of SPF records in DNS.

        ### Running the Policy

        ```
        $ cat <<EOF >domains.txt
        > mondoo.com
        > google.com
        > microsoft.com
        > EOF
        $ cnspec scan --inventory-domainlist --inventory-file domains.txt --policy-bundle ./email-security.mql.yaml --incognito
        ```
    groups:
      - title: Email Security
        filters: asset.platform == "host"
        checks:
          - uid: dns-00
          - uid: dns-01
          - uid: spf-01
          - uid: spf-02
          - uid: spf-03
          - uid: spf-04
          - uid: spf-05
          - uid: spf-06
queries:
  - uid: dns-00
    title: Domain Apex should have a TXT record
    mql: dns.records.where( type == "TXT" ).length > 0
    docs:
      desc: |
        A TXT record is a type of resource record in the Domain Name System (DNS) used to provide the ability to associate arbitrary text with a host or other name, such as human readable information about a server, network, data center, or other accounting information.
      audit: Run the `dig -t TXT <domain>` command and verify that the SPF record is set
      remediation: |
        Add a TXT record to your DNS zone file.
    refs:
      - url: https://en.wikipedia.org/wiki/TXT_record
        title: TXT Record
  - uid: dns-01
    title: Domain Apex should have an anchor (A) record
    mql: dns.records.where( type == "A" ).length > 0
    docs:
      desc: |
        A domains apex anchor record should be set to something, even if it's a redirect.
      audit: Run the `dig -t A <domain>` command and verify that there is an A record
      remediation: |
        Add an A record to your DNS zone file, consider using a redirect to your corporate website.
    refs:
      - url: https://www.easyredir.com/blog/what-is-an-apex-domain/
        title: A Record
  - uid: spf-01
    title: Ensure SPF record is set
    mql: dns.params['TXT']['rData'].contains( /v=spf1/ )
    docs:
      desc: |
        SPF (Sender Policy Framework) is a method of preventing email spoofing by allowing the owner of a domain to publish a list of mail servers that are authorized to send email from that domain.
      audit: Run the `dig -t TXT <domain>` command and verify that the SPF record is set
      remediation: |
        Add a TXT record to your DNS zone file with the following format:
        ```
        <domain> IN TXT "v=spf1 include:_spf.google.com ~all"
        ```
    refs:
      - url: https://en.wikipedia.org/wiki/Sender_Policy_Framework
        title: SPF Record
  - uid: spf-02
    title: Ensure there are not multiple SPF record
    mql: dns.params['TXT']['rData'].where( /v=spf1/ ).length <= 1
    docs:
      desc: A domain should have only one SPF record.
      audit: Run the `dig -t TXT <domain>` command and verify that there is only one SPF record
      remediation: |
        Remove all but one SPF record from your DNS zone file.
    refs:
      - url: https://en.wikipedia.org/wiki/Sender_Policy_Framework
        title: SPF Record
  - uid: spf-03
    title: Ensure SPF record is not too long
    mql: dns.params['TXT']['rData'].where( /v=spf1/ ).length <= 255
    docs:
      desc: The SPF record should not be longer than 255 characters.
      audit: Run the `dig -t TXT <domain>` command and verify that the SPF record is not longer than 255 characters
      remediation: |
        Remove some of the entries from your SPF record.
    refs:
      - url: https://en.wikipedia.org/wiki/Sender_Policy_Framework
        title: SPF Record
  - uid: spf-04
    title: Ensure SPF record does not contain any excess whitespace
    mql: dns.params['TXT']['rData'].where( /v=spf1/ ).where( /\s{2,}/).length == 0
    docs:
      desc: The SPF record should not contain any unnecessary whitespace.
      audit: Run the `dig -t TXT <domain>` command and verify that the SPF record does not contain any whitespace
      remediation: |
        Remove all excess whitespace from your SPF record.
    refs:
      - url: https://en.wikipedia.org/wiki/Sender_Policy_Framework
        title: SPF Record
  - uid: spf-05
    title: SPF should be set to fail or soft fail all
    mql: |
      dns.params['TXT']['rData'].where( /v=spf1/ ).any(/~all/)
    docs:
      desc: The SPF record should be set to soft fail all.
      audit: Run the `dig -t TXT <domain>` command and verify that the SPF record is set to fail or soft fail all
      remediation: |
        The SPF record should end with ~all.
    refs:
      - url: https://www.m3aawg.org/sites/default/files/m3aawg-email-authentication-recommended-best-practices-09-2020.pdf
        title: M3AAWG Email Authentication Recommended Best Practices (2020)
  - uid: spf-06
    title: Do not use deprecated SPF DNS Record Type
    mql: dns.records.where(type == "SPF").length == 0
    docs:
      desc: The SPF record should not use the deprecated SPF DNS Record Type.
      audit: Run the `dig SPF <domain>` command and verify that the SPF record does not use the deprecated SPF DNS Record Type
      remediation: |
        Remove the deprecated SPF DNS Record Type from your SPF record.
    refs:
      - url: https://en.wikipedia.org/wiki/Sender_Policy_Framework#DNS_SPF_Records
        title: DNS SPF Records

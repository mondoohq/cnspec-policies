policies:
  - uid: mondoo-google-workspace-security
    name: Google Workspace Security by Mondoo
    version: 1.0.0
    license: unspecified
    tags:
      mondoo.com/category: security
      mondoo.com/platform: google-workspace,saas
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    docs:
      desc: "## Overview\n\nThe Mondoo Google Workspace Incident Response query pack gathers configuration data about your Google Workspace investigation during a security incident.\n\n### Prerequisites\n\n1. Create/Select a GCP project\n2. Navigate to the [Google API Console](https://console.cloud.google.com/apis/dashboard). \n3. Select \"Enable APIs and Services\" and enable the following APIs:\n  - Admin SDK API \n  - Cloud Identity API \n  - Google Calendar API\n  - Google Drive API\n  - Gmail API\n  - Google People API\n4. Create a service account for [Google Workspace](https://support.google.com/a/answer/7378726?product_name=UnuFlow&hl=en&visit_id=638041387835615758-4147680582&rd=1&src=supportwidget0&hl=en)\n5. Create credentials for the service account and download the json file\n6. Enter the following scopes in Security -> Access and data controls -> API controls, and select [Domain-wide Delegation](https://developers.google.com/workspace/guides/create-credentials#delegate_domain-wide_authority_to_your_service_account) \n\n  - https://www.googleapis.com/auth/admin.chrome.printers.readonly\n  - https://www.googleapis.com/auth/admin.directory.customer.readonly\n  - https://www.googleapis.com/auth/admin.directory.device.chromeos.readonly\n  - https://www.googleapis.com/auth/admin.directory.device.mobile.readonly\n  - https://www.googleapis.com/auth/admin.directory.domain.readonly\n  - https://www.googleapis.com/auth/admin.directory.group.member.readonly\n  - https://www.googleapis.com/auth/admin.directory.group.readonly\n  - https://www.googleapis.com/auth/admin.directory.orgunit.readonly\n  - https://www.googleapis.com/auth/admin.directory.resource.calendar.readonly\n  - https://www.googleapis.com/auth/admin.directory.rolemanagement.readonly\n  - https://www.googleapis.com/auth/admin.directory.user.alias.readonly\n  - https://www.googleapis.com/auth/admin.directory.user.readonly\n  - https://www.googleapis.com/auth/admin.directory.userschema.readonly\n  - https://www.googleapis.com/auth/admin.reports.audit.readonly\n  - https://www.googleapis.com/auth/admin.reports.usage.readonly\n  - https://www.googleapis.com/auth/admin.directory.user.security\n  - https://www.googleapis.com/auth/cloud-identity.groups.readonly\n\n### Run policy\n\nTo run this policy against a Google Workspace customer:\n\n```bash\nexport GOOGLEWORKSPACE_CREDENTIALS=$PWD/my-project-123456-1234ea722b12.json\ncnspec scan google-workspace --customer-id <CUSTOMERID> --impersonated-user-email <EMAIL>\n```\n\n## Join the community!\n\nOur goal is to build policies that are simple to deploy, accurate, and actionable. \n\nIf you have any suggestions on how to improve this policy, or if you need support, [join the community](https://github.com/orgs/mondoohq/discussions) in GitHub Discussions.\n"
    groups:
      - filters: asset.platform == "google-workspace" || asset.platform == "googleworkspace"
        checks:
          - uid: mondoo-googleworkspace-security-less-secure-app-access-should-not-be-allowed
          - uid: mondoo-googleworkspace-security-limit-super-admins
          - uid: mondoo-googleworkspace-security-minimum-super-admins
          - uid: mondoo-googleworkspace-security-super-admins-should-use-hardware-based-2fa
          - uid: mondoo-googleworkspace-security-two-step-verification-enforced
queries:
  - uid: mondoo-googleworkspace-security-two-step-verification-enforced
    title: Ensure 2-step verification (multi-factor authentication) is enforced for all users
    mql: googleworkspace.users.all ( isEnforcedIn2Sv == true )
  - uid: mondoo-googleworkspace-security-limit-super-admins
    title: Ensure fewer than three users have super admin permissions
    mql: googleworkspace.report.users.where(security["isSuperAdmin"] == true).length <= 3
  - uid: mondoo-googleworkspace-security-minimum-super-admins
    title: Ensure more than one user has super admin permissions
    mql: googleworkspace.report.users.where(security["isSuperAdmin"] == true).length > 1
  - uid: mondoo-googleworkspace-security-less-secure-app-access-should-not-be-allowed
    title: Users should not be allowed less secure app access
    mql: googleworkspace.report.users.all(security["isLessSecureAppsAccessAllowed"] == false)
  - uid: mondoo-googleworkspace-security-super-admins-should-use-hardware-based-2fa
    title: Super users should use hardware-based security keys
    mql: googleworkspace.report.users.where(security["isSuperAdmin"] == true).all(security["numSecurityKeys"] >= 1)

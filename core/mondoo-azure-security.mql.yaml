# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1

policies:
  - uid: mondoo-azure-security
    name: Microsoft Azure Security
    version: 1.3.0
    license: BUSL-1.1
    tags:
      mondoo.com/category: security
      mondoo.com/platform: azure,cloud
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    docs:
      desc: |-
        ## Overview

        Microsoft Azure Security by Mondoo provides guidance for establishing minimum recommended security and operational best practices for Microsoft Azure.

        ## Remote scan

        Remote scans use native transports in cnspec to provide on-demand scan results without installing agents or integrations.

        For a complete list of native transports run:

        ```bash
        cnspec scan --help
        ```

        ### Prerequisites

        Remote scans of Azure require API credentials with access to the subscription.

        Note: Some of the checks in this policy query data using Microsoft's Graph API. To successfully run these checks, you must create an Azure AD app registration for cnspec with proper permissions. Follow the instructions on https://mondoo.com/docs/platform/cloud/azure/azure-integration-scan/ to set up this app.

        To run all checks at the same time, ensure your app registration has the necessary permissions as described above and then run:

        ```bash
        cnspec scan azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id> --policy-bundle mondoo-azure-security.mql.yaml
        ```

        ### Scan an Azure subscription

        ```bash
        cnspec scan azure --subscription <subscription_id>
        ```

        ## Join the community!

        Our goal is to build policies that are simple to deploy, accurate, and actionable.

        If you have any suggestions for how to improve this policy or need support, [join the community](https://github.com/orgs/mondoohq/discussions) in GitHub Discussions.
    groups:
      - title: Azure Core
        filters: |
          asset.platform == "azure"
          asset.kind == "api"
        checks:
          - uid: mondoo-azure-security-default-network-access-rule-storage-accounts-deny
          - uid: mondoo-azure-security-diagnostic-settings-essential-categories
          - uid: mondoo-azure-security-diagnostic-settings-exist
          - uid: mondoo-azure-security-disable-udp-virtualmachines
          - uid: mondoo-azure-security-enable-azure-ad-identity-protection-sign-in-risk-policies
          - uid: mondoo-azure-security-enable-azure-ad-identity-protection-user-risk-policies
          - uid: mondoo-azure-security-ensure-activity-log-alert-exists-for-create-update-delete-network-security-group
          - uid: mondoo-azure-security-ensure-auditing-on
          - uid: mondoo-azure-security-ensure-auditing-retention-greater-than-30-days
          - uid: mondoo-azure-security-ensure-deny-public-access-mariadb
          - uid: mondoo-azure-security-ensure-disabled-public-access-sql
          - uid: mondoo-azure-security-ensure-logging-enabled-kv
          - uid: mondoo-azure-security-ensure-multifactor-authentication-is-enabled-for-all-users-in-administrative-roles
          - uid: mondoo-azure-security-ensure-multifactor-authentication-is-enabled-for-all-users-in-all-roles
          - uid: mondoo-azure-security-ensure-os-disk-are-encrypted
          - uid: mondoo-azure-security-ensure-register-with-ad-is-enabled-on-app-service
          - uid: mondoo-azure-security-ensure-security-defaults-is-enabled-on-azure-active-directory
          - uid: mondoo-azure-security-ensure-that-between-two-and-four-global-admins-are-designated
          - uid: mondoo-azure-security-ensure-that-notify-about-alerts-with-high-severity-is-on
          - uid: mondoo-azure-security-ensure-that-ssl-enabled-latest-version-mariadb
          - uid: mondoo-azure-security-ensure-that-ssl-enabled-latest-version-mysql
          - uid: mondoo-azure-security-ensure-that-ssl-enabled-postgresql
          - uid: mondoo-azure-security-ensure-the-expiration-date-is-set-for-all-keys-and-secrets-in-kv
          - uid: mondoo-azure-security-ensure-the-kv-is-recoverable
          - uid: mondoo-azure-security-ensure-web-app-is-using-the-latest-tls
          - uid: mondoo-azure-security-keyvault-public-access-disabled
          - uid: mondoo-azure-security-no-sql-databases-allow-ingress-0-0-0-0-0
          - uid: mondoo-azure-security-public-access-level-private-blob-containers
          - uid: mondoo-azure-security-rdp-access-restricted-from-internet
          - uid: mondoo-azure-security-secure-transfer-required-enabled
          - uid: mondoo-azure-security-sql-server-audit-on
          - uid: mondoo-azure-security-sql-server-tde-on
          - uid: mondoo-azure-security-ssh-access-restricted-from-internet
          - uid: mondoo-azure-security-trusted-microsoft-services-enabled-for-storage-account-access
    scoring_system: 2
queries:
  - uid: mondoo-azure-security-ensure-multifactor-authentication-is-enabled-for-all-users-in-all-roles
    title: Ensure that multi-factor authentication has been enabled for all users
    impact: 100
    mql: |
      microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'MFARegistrationV2' &&  _['score'] == 9)
    docs:
      desc: |
        This check ensures that the MFA has been enabled for all users in the Microsoft Azure tenant.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'MFARegistrationV2' &&  _['score'] == 9)" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'MFARegistrationV2' &&  _['score'] == 9 )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in as a Conditional Access Administrator, Security Administrator, or Global Administrator to the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to **Azure Active Directory -> Security -> Conditional Access**.
        3. Select **New Policy** with these conditions:
           * Grant: Grant access (Require multi-factor authentication)
           * Users: All users
           * Cloud apps or actions: All cloud apps
        5. Make sure that the policy is enabled. You can also set **Enable policy** to **Report-only**. After confirming your settings using report-only mode, an administrator can switch the **Enable policy** toggle from **Report-only** to **On**.
  - uid: mondoo-azure-security-ensure-multifactor-authentication-is-enabled-for-all-users-in-administrative-roles
    title: Ensure all users in administrative roles have MFA enabled
    impact: 100
    mql: |
      microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'AdminMFAV2' && _['score'] == 10 )
    docs:
      desc: |
        Enable multi-factor authentication for all users in administrative roles!
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Run this query:

          ```bash
          cnspec run azure -c "microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'AdminMFAV2' && _['score'] == 10)" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'AdminMFAV2' && _['score'] == 10 )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in as a Conditional Access Administrator, Security Administrator, or Global Administrator to the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to Azure Active Directory -> Security -> Conditional Access
        3. Select **New Policy** with following conditions:
           * Grant: Grant access (Require multi-factor authentication)
           * Users -> Users and groups -> Include -> Select users and groups -> Directory roles: At minimum select Billing admin, Conditional Access admin, Exchange admin, Global admin, Helpdesk admin, Security admin, SharePoint admin, and User admin.
           * Cloud apps or actions: All cloud apps
        5. Make sure that the policy is enabled. You can also set **Enable policy** to **Report-only**. After confirming your settings using report-only mode, an administrator can switch the **Enable policy** toggle from **Report-only** to **On**.
  - uid: mondoo-azure-security-ensure-that-between-two-and-four-global-admins-are-designated
    title: Ensure that at least three but not more than four global admins are designated
    impact: 60
    mql: |
      microsoft.rolemanagement.roleDefinitions.where(displayName == "Global Administrator").all(assignments.length > 1 && assignments.length <= 4)
    docs:
      desc: |
        This check ensures that there are enough Global Admins in a single tenant.
         When designating global admins, it's important to consider the size and complexity of the organization, as well as the level of responsibility and authority required for the role. As a general rule, it's a good idea to have at least three global admins to ensure that there is redundancy and coverage in case one admin is unavailable or leaves the organization.

        At the same time, having too many global admins can lead to confusion and inefficiency, as multiple people may be making decisions or taking actions without proper coordination. Therefore, it's recommended to limit the number of global admins to four, unless the organization is particularly large or complex and requires more administrators to properly manage its operations.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Run this query:

          ```bash
          cnspec run azure -c "microsoft.rolemanagement.roleDefinitions.where(displayName == "Global Administrator").all(assignments.length > 1 && assignments.length <= 4)" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```
        __cnspec shell__

        To audit Microsoft azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          microsoft.rolemanagement.roleDefinitions.where(displayName == "Global Administrator").all(assignments.length > 1 && assignments.length <= 4)
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
         1. Log into the Microsoft Azure portal at https://portal.azure.com as a global administrator.
         2. Navigate to Azure Active Directory
         3. Select **Users -> New user **.
         4. If there are not enough global admins, create one:
            * Select the user name.
            * Under **Roles**, select **Global Administrator ** and then select **Save changes**.
         5. Remove the Global Admin, if there are more than four Global Administrators
            * Select the user name.
            * Under Roles, select **Manage roles** and then deselect Global Administrator.
            * Select **Save changes**.
  - uid: mondoo-azure-security-ensure-security-defaults-is-enabled-on-azure-active-directory
    title: Ensure that the security defaults are disabled
    impact: 80
    mql: |
      microsoft.policies.identitySecurityDefaultsEnforcementPolicy["isEnabled"] == true
    docs:
      desc: |
        This check ensures that the security defaults (which are enabled by default) are enabled in Azure Active Directory.

        The security defaults help protect user accounts from password spray and phishing attacks by:

        * Requiring all users and admins to register for MFA using the Microsoft Authenticator app.
        * Challenging users with MFA when they log in from a new device or app or for critical roles and tasks.
        * Disabling authentication from legacy authentication clients that can't do MFA.
        * Protecting admins by requiring extra authentication every time they log in.

        Note: Advanced security configurations require you to disable the security defaults.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Run this query:

          ```bash
          cnspec run azure -c "microsoft.policies.identitySecurityDefaultsEnforcementPolicy["isEnabled"] == false" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          microsoft.policies.identitySecurityDefaultsEnforcementPolicy["isEnabled"] == false
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log into the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to **Azure Active Directory -> properties -> Select "manage security defaults"**.
        3. Verify the "Enable security defaults" toggle is Yes.
  - uid: mondoo-azure-security-enable-azure-ad-identity-protection-sign-in-risk-policies
    title: Enable sign-in risk policy for MFA
    impact: 80
    mql: |
      microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'SigninRiskPolicy' && _['score'] == 7 )
    docs:
      desc: |
        This check ensures that there are some policies in place which can detect risky sign-in in real-time and offline. A risky sign-in mainly means a sign-in attempt which might be performed by illegitimate owner of a user account.

        Most users have a normal behavior that can be tracked. When they fall outside of this norm, it could be risky to allow them to successfully sign in. Instead, you may want to block that user, or ask them to perform a multi-factor authentication. If the user successfully completes the MFA challenge, you can consider it a valid sign-in attempt and grant access to the application or service.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Run this query:

          ```bash
          cnspec run azure -c "microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'SigninRiskPolicy' && _['score'] == 7 )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```
        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'SigninRiskPolicy' && _['score'] == 7 )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log into the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to **Azure Active Directory -> Security -> Identity Protection -> Sign-in risk policy**.
        3. Make sure the policy applies to all users.
        4. Under Conditions, choose **Select conditions -> Select a risk level**, then choose **Medium and above**.
        5. Under Access, choose **Select a control**. Make sure the **Allow access and require multi-factor authentication** option is checked, then choose **Select**.
        6. Set **Enforce Policy** to **On**, then select **Save**.
  - uid: mondoo-azure-security-enable-azure-ad-identity-protection-user-risk-policies
    title: Enable user risk policy for password change
    impact: 100
    mql: |
      microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'UserRiskPolicy' && _['score'] == 7 )
    docs:
      desc: |
        This check ensures that there are policies in place that can detect risky sign-in, both in real time and offline. A risky sign-in generally means a sign-in attempt performed by someone other than the account owner.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Run this query:

          ```bash
          cnspec run azure -c "microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'UserRiskPolicy' && _['score'] == 7 )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```
        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          microsoft.security.latestSecureScores.controlScores.one( _['controlName'] == 'UserRiskPolicy' && _['score'] == 7 )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log into the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to **Azure Active Directory -> Security -> Identity Protection -> User risk policy**.
        3. Make sure the policy applies to all users.
        4. Under **Conditions**, choose **Select conditions -> Select a risk level**, then choose **Medium and above**.
        5. Under **Access,** select **Access**. Make sure the **Allow access and Require password change** is checked, then choose **Select**.
        6. Set **Enforce Policy** to **On**, then select **Save**.
  - uid: mondoo-azure-security-ensure-os-disk-are-encrypted
    title: Ensure that 'OS' disks are encrypted
    impact: 80
    mql: |
      azure.subscription.compute.vms {
        osDisk {
          properties['encryption'] != null
        }
      }
    docs:
      desc: |
        This check ensures that both OS disks (boot volumes) are encrypted. Customer Managed keys can be either ADE or Server Side Encryption(SSE).
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.compute.vms { osDisk { properties['encryption'] } }"
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Launch `cnspec shell`:

          ```bash
          cnspec shell azure
          ```

        3. Run this query:

          ```mql
          azure.subscription.compute.vms { osDisk { properties['encryption'] } }
          ```
      remediation: |
        ###Terraform

        __Encrypt disks Linux VM__

        ```hcl
        # Encrypt Linux OS disk with Terraform
        resource "azure_linux_virtual_machine" "example" {
          name                = "example-linux-machine"
          resource_group_name = azure_resource_group.example.name
          location            = azure_resource_group.example.location

          ...

          encryption_at_host_enabled = true

          ...
        }
        ```

        __Encrypt disks Windows VM__

        ```hcl
        resource "azure_windows_virtual_machine" "example" {
          name                = "example-windows-machine"
          resource_group_name = azure_resource_group.example.name
          location            = azure_resource_group.example.location

          ...

          encryption_at_host_enabled = true

          ...
        }
        ```

        __Encrypt disks managed disks__

        ```hcl
        resource "azure_managed_disk" "example" {
          name                 = var.disk_name
          location             = var.location
          resource_group_name  = var.resource_group_name
          ...

          encryption_settings {
            enabled = true
          }

          ...
        }
        ```

        ###Azure Console

        To update via the Azure Console:

        1. Log into the Azure Console at https://portal.azure.com/.
        2. Go to **Virtual machines**.
        2. For each virtual machine, go to **Settings**
        3. Select **Disks**.
        4. Select the **X** to detach the disk from the VM.
        5. Search for **Disks** and locate any unattached disk.
        6. Select the disk, then select **Encryption**.
        7. Change your encryption type, then select the encryption set.
        8. Select **Save**.
        9. Go back to the VM and re-attach the disk.

        ###Azure CLI

        ```bash
        az vm encryption enable -g <resource_group> --name <vm_name> --disk-encryption-keyvault <keyvault_name>
        ```
    refs:
      - url: https://learn.microsoft.com/en-us/azure/virtual-machines/disk-encryption-overview
        title: Overview of managed disk encryption options
  - uid: mondoo-azure-security-ssh-access-restricted-from-internet
    title: Ensure that SSH access is restricted from the internet
    impact: 80
    mql: |
      azure.subscription.network.securityGroups {
        securityRules.where( properties['access'] == 'Allow' && properties['direction'] == 'Inbound' && properties['protocol'] == /TCP|\*/ && properties['sourceAddressPrefix'] == /\*|0\.0\.0\.0|<nw>\/0|\/0|internet|any/ )
        } {
          securityRules {
            properties["destinationPortRange"] != "*"
            properties["destinationPortRange"] != 22
            if (properties["destinationPortRange"].split("-").length > 1) {
              a = properties["destinationPortRange"].split("-")[0] < 22 && properties["destinationPortRange"].split("-")[1] < 22
              b = properties["destinationPortRange"].split("-")[0] > 22 && properties["destinationPortRange"].split("-")[1] > 22
              a || b
            }
            properties["destinationPortRanges"].all( _ != 22 )
        }
      }
    docs:
      desc: |
        This check ensures whether SSH on port 22 is not configured to allow access from anywhere with the CIDR block "0.0.0.0".
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.network.securityGroups { securityRules }"
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Launch `cnspec shell`:

          ```bash
          cnspec shell azure
          ```

        3. Run this query:

          ```mql
          azure.subscription.network.securityGroups { securityRules }
          ```
      remediation: |
        ###Terraform

        ```hcl
        # Ensure the `source_address_prefix` is configured to a restrictive CIDR address

        resource "azure_network_security_group" "my_terraform_nsg" {
          name                = "myNetworkSecurityGroup"
          location            = azure_resource_group.rg.location
          resource_group_name = azure_resource_group.rg.name

          security_rule {
            name                       = "SSH"
            priority                   = 1001
            direction                  = "Inbound"
            access                     = "Allow"
            protocol                   = "Tcp"
            source_port_range          = "*"
            destination_port_range     = "22"
            source_address_prefix      = "192.168.22.5/24"
            destination_address_prefix = "*"
          }
        }
        ```
  - uid: mondoo-azure-security-rdp-access-restricted-from-internet
    title: Ensure that RDP access is restricted from the internet
    impact: 80
    mql: |
      azure.subscription.network.securityGroups {
        securityRules.where( properties['access'] == 'Allow' && properties['direction'] == 'Inbound' && properties['protocol'] == /TCP|\*/ && properties['sourceAddressPrefix'] == /\*|0\.0\.0\.0|<nw>\/0|\/0|internet|any/ )
        } {
          securityRules {
            properties["destinationPortRange"] != "*"
            properties["destinationPortRange"] != 3389
            if (properties["destinationPortRange"].split("-").length > 1) {
              a = properties["destinationPortRange"].split("-")[0] < 3389 && properties["destinationPortRange"].split("-")[1] < 3389
              b = properties["destinationPortRange"].split("-")[0] > 3389 && properties["destinationPortRange"].split("-")[1] > 3389
              a || b
            }
            properties["destinationPortRanges"].all( _ != 3389 )
        }
      }
    docs:
      desc: |
        This check ensures whether RDP on port 3389 is not configured to allow access from anywhere with the CIDR block "0.0.0.0".
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.network.securityGroups { securityRules }"
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Launch `cnspec shell`:

          ```bash
          cnspec shell azure
          ```

        3. Run this query:

          ```mql
          azure.subscription.network.securityGroups { securityRules }
          ```
      remediation: |
        ###Terraform

        ```hcl
        # Ensure the `source_address_prefix` is configured to a restrictive CIDR address

        resource "azure_network_security_group" "example" {
          name                = "example-rdp-security"
          location            = azure_resource_group.rg.location
          resource_group_name = azure_resource_group.rg.name

          security_rule {
            name                       = "RDP"
            priority                   = 1001
            direction                  = "Inbound"
            access                     = "Allow"
            protocol                   = "Tcp"
            source_port_range          = "*"
            destination_port_range     = "3389"
            source_address_prefix      = "192.168.22.5/24"
            destination_address_prefix = "*"
          }
        }
        ```
  - uid: mondoo-azure-security-secure-transfer-required-enabled
    title: Ensure that 'Secure transfer required' is set to 'Enabled'
    impact: 80
    mql: |
      azure.subscription.storage.accounts {
        properties['supportsHttpsTrafficOnly'] == true || properties['enableHttpsTrafficOnly'] == true
      }
    docs:
      desc: |
        This check ensures that data encryption in transit is enabled.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.storage.accounts { properties['supportsHttpsTrafficOnly'] }"
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Launch `cnspec shell`:

          ```bash
          cnspec shell azure
          ```

        3. Run this query:

          ```mql
          azure.subscription.storage.accounts { properties['supportsHttpsTrafficOnly'] }
          ```
      remediation: |
        ###Terraform

        ```hcl
        resource "azure_storage_account" "example_storage_account" {
          ...
          enable_https_traffic_only = true
        }
        ```
  - uid: mondoo-azure-security-public-access-level-private-blob-containers
    title: Ensure that 'Public access level' is set to Private for blob containers
    impact: 80
    mql: |
      azure.subscription.storage.accounts.all( properties["allowBlobPublicAccess"] == "false" ) || azure.subscription.storage.accounts.all ( containers { properties["publicAccess"] == "None" } )
    docs:
      desc: |
        This check ensures that anonymous access to blob containers is disabled, and public access on storage accounts is disabled.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.storage.accounts { containers { properties['publicAccess'] == "None" } }"
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Launch `cnspec shell`:

          ```bash
          cnspec shell azure
          ```

        3. Run this query:

          ```mql
          azure.subscription.storage.accounts { containers { properties['publicAccess'] == "None" } }
          ```
      remediation: |
        ###Terraform

        ```hcl
        resource "azure_storage_container" "example_storage_container" {
            ...
          container_access_type = "private"
        }
        ```

        ###Azure Portal

        1. Log into the Azure Portal at https://portal.azure.com.
        2. Navigate to **Storage Accounts**.
        3. Navigate to **BLOB SERVICE**.
        4. Select **Containers**.
        5. Select a container and select **Access policy**.
        6. Set **Public Access Level** to **Private**.
        7. Repeat For each Container.

        Repeat steps 3-7 for each storage account.

        ###Azure CLI

        ```bash
        az storage container set-permission
        --name <container_name>
        --public-access off
        --account-name <account_name>
        --account-key <account_key>
        ```
  - uid: mondoo-azure-security-default-network-access-rule-storage-accounts-deny
    title: Ensure the default network access rule for Storage Accounts is set to deny
    impact: 80
    mql: |
      azure.subscription.storage.accounts.all( properties["networkAcls"]["defaultAction"] == "Deny" )
    docs:
      desc: |
        This check ensures that access to the default network for storage accounts is set to deny.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.storage.accounts { containers { properties['publicAccess'] == "None" } }"
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Launch `cnspec shell`:

          ```bash
          cnspec shell azure
          ```

        3. Run this query:

          ```mql
          azure.subscription.storage.accounts { containers { properties['publicAccess'] == "None" } }
          ```
      remediation: |
        ###Terraform

        ```hcl
        # Ensure the `default_action` is set to `Deny`

        resource "azure_storage_account_network_rules" "example_storage_account" {
          resource_group_name  = azure_resource_group.example.name
          storage_account_name = azure_storage_account.example.name

          default_action       = "Deny"
        }
        ```

        ```hcl
        resource "azure_storage_account" "example_storage_account" {
          name                = "example_storage_account"
          resource_group_name = azure_resource_group.example.name
          location            = azure_resource_group.example.location

          network_rules {
            default_action = "Deny"
          }

          ...
        }
        ```
  - uid: mondoo-azure-security-trusted-microsoft-services-enabled-for-storage-account-access
    title: Ensure 'Trusted Microsoft Services' is enabled for Storage Account access
    impact: 80
    mql: |
      azure.subscription.storage.accounts.all ( properties['networkAcls']['bypass'] == "AzureServices")
    docs:
      desc: |
        This check ensures that 'Trusted Microsoft Services' is enabled for Storage Account access.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.storage.accounts.all ( properties['networkAcls']['bypass'] == "AzureServices")"
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Launch `cnspec shell`:

          ```bash
          cnspec shell azure
          ```

        3. Run this query:

          ```mql
          azure.subscription.storage.accounts.all ( properties['networkAcls']['bypass'] == "AzureServices")
          ```
      remediation: |
        ###Terraform

        ```hcl
        resource "azure_storage_account" "example" {
            ...
          network_rules {
            ...
            bypass = ["AzureServices"]
            ...
          }
        }
        ```
  - uid: mondoo-azure-security-ensure-auditing-on
    title: Ensure that 'Auditing' is set to 'On' for SQL Server
    impact: 80
    mql: |
      azure.subscription.sql.servers {
        auditingPolicy['state'] == "Enabled"
      }
    docs:
      desc: |
        This check ensures that 'Auditing' is set to 'On' for SQL Server.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.sql.servers { auditingPolicy['state'] }"
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Launch `cnspec shell`:

          ```bash
          cnspec shell azure
          ```

        3. Run this query:

          ```mql
          azure.subscription.sql.servers { auditingPolicy['state'] }
          ```
      remediation: |
        ###Terraform

        ```hcl
        resource "azure_sql_server" "example_sql_server" {
          ...

          extended_auditing_policy {
            storage_endpoint                        = azure_storage_account.example.primary_blob_endpoint
            storage_account_access_key              = azure_storage_account.example.primary_access_key
            storage_account_access_key_is_secondary = true
            retention_in_days                       = 90
          }
        }
        ```
  - uid: mondoo-azure-security-ensure-auditing-retention-greater-than-30-days
    title: Ensure that 'Auditing' Retention is 'greater than 30 days'
    impact: 80
    mql: |
      azure.subscription.sql.servers {
        auditingPolicy['retentionDays'] >= 30
      }
    docs:
      desc: |
        This check ensures that 'Auditing' Retention is 'greater than or equal to 30 days'
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.sql.servers { auditingPolicy['retentionDays'] }"
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Launch `cnspec shell`:

          ```bash
          cnspec shell azure
          ```

        3. Run this query:

          ```mql
          azure.subscription.sql.servers { auditingPolicy['retentionDays'] }
          ```
      remediation: |
        ###Terraform

        ```hcl
        resource "azure_sql_server" "example" {
          ...
          extended_auditing_policy {
            storage_endpoint           = azure_storage_account.example.primary_blob_endpoint
            storage_account_access_key = azure_storage_account.example.primary_access_key
            storage_account_access_key_is_secondary = true
            retention_in_days                       = 30
          }
        }
        ```
  - uid: mondoo-azure-security-no-sql-databases-allow-ingress-0-0-0-0-0
    title: Ensure no SQL Databases allow ingress 0.0.0.0/0 (ANY IP)
    impact: 80
    mql: |
      azure.subscription.sql.servers {
        firewallRules.length >= 1
        firewallRules {
          startIpAddress != '0.0.0.0'
        }
      }
      azure.subscription.postgreSql.servers {
        firewallRules.length >= 1
        firewallRules {
          startIpAddress != '0.0.0.0'
        }
      }
      azure.subscription.mySql.servers {
        firewallRules.length >= 1
        firewallRules {
          startIpAddress != '0.0.0.0'
        }
      }
      azure.subscription.mariaDb.servers {
        firewallRules.length >= 1
        firewallRules {
          startIpAddress != '0.0.0.0'
        }
      }
    docs:
      desc: |
        This check ensures that no SQL databases allow ingress connections from "0.0.0.0".
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.sql.servers { firewallRules { startIpAddress } }"
          cnspec run azure -c "azure.subscription.postgreSql.servers { firewallRules { startIpAddress } }"
          cnspec run azure -c "azure.subscription.mariaDb.servers { firewallRules { startIpAddress } }"
          cnspec run azure -c "azure.subscription.mySql.servers { firewallRules { startIpAddress } }"
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Run `az login` to authenticate with the correct Azure subscription and tenant.
        2. Launch `cnspec shell`:

          ```bash
          cnspec shell azure
          ```

        3. Run this query:

          ```mql
          azure.subscription.sql.servers { firewallRules { startIpAddress } }
          azure.subscription.postgreSql.servers { firewallRules { startIpAddress } }
          azure.subscription.mariaDb.servers { firewallRules { startIpAddress } }
          azure.subscription.mySql.servers { firewallRules { startIpAddress } }
          ```
      remediation: |
        ###Terraform

        __mySQL__

        ```hcl
        # Ensure `start_ip_address` is not configured to `0.0.0.0`

        resource "azure_mysql_firewall_rule" "example" {
          ...
          start_ip_address    = "192.168.2.22"
          end_ip_address      = "255.255.255.255"
        }
        ```

        __MariaDB__

        ```hcl
        # Ensure `start_ip_address` is not configured to `0.0.0.0`

        resource "azure_mariadb_firewall_rule" "example" {
          ...
          start_ip_address    = "192.168.2.22"
          end_ip_address      = "255.255.255.255"
        }
        ```

        __SQL__

        ```hcl
        # Ensure `start_ip_address` is not configured to `0.0.0.0`

        resource "azure_sql_firewall_rule" "example" {
          ...
          start_ip_address    = "192.168.2.22"
          end_ip_address      = "255.255.255.255"
        }
        ```

        __Postgres__

        ```hcl
        # Ensure `start_ip_address` is not configured to `0.0.0.0`

        resource "azure_postgresql_firewall_rule" "example" {
          ...
          start_ip_address    = "192.168.2.22"
          end_ip_address      = "255.255.255.255"
        }
        ```
  - uid: mondoo-azure-security-ensure-register-with-ad-is-enabled-on-app-service
    title: Ensure that App Services can authenticate with Active Directory
    impact: 80
    mql: |
      azure.subscription.web.apps {
        identity["type"] == "SystemAssigned" || identity["principalId"] != null
      }
    docs:
      desc: |
        This check ensures that the App services be able to authenticate through Azure AD.

        In this way, the secrets will be removed from the app itself, and instead the app will connect to other Azure services securely without the need for usernames and passwords.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.web.apps { identity["type"] == "SystemAssigned" || identity["principalId"] != null }" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.web.apps { identity["type"] == "SystemAssigned" || identity["principalId"] != null }
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to **App Services**.
        3. Select each App, under "setting" select on "identity"
        4. Under the "System assigned" pane, set "Status" to "On"
  - uid: mondoo-azure-security-ensure-web-app-is-using-the-latest-tls
    title: Ensure that Web Apps use the latest available version of TLS encryption
    impact: 80
    mql: |
      azure.subscription.web.apps {
        configuration.properties["minTlsVersion"] == "1.2"
      }
    docs:
      desc: |
        It is highly recommended to use the latest TLS version available with Azure App Services for all secure Web App connections. Currently Azure App Services supports TLS 1.2.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.web.apps { configuration.properties["minTlsVersion"] == "1.2" }" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.web.apps { configuration.properties["minTlsVersion"] == "1.2" }
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to **App Services**.
        3. Select each App, under "setting" select on "TLS/SSL settings"
        4. Under the "Bindings" pane, ensure that "Minimum TLS Version" set to "1.2" under "Protocol Settings".
  - uid: mondoo-azure-security-ensure-the-expiration-date-is-set-for-all-keys-and-secrets-in-kv
    title: Ensure that the expiration date is set for all keys and secrets in key vaults
    impact: 80
    mql: |
      azure.subscription.keyVault.vaults {
        keys.all( enabled && expires != null )
      }
      azure.subscription.keyVault.vaults {
        secrets.all( enabled == true && expires != null )
      }
    docs:
      desc: |
        The expiration time attribute identifies the expiration time which after the key/secret must not be used for a cryptographic operation.
        By default, keys/secrets never expire. Therefore, it is highly recommended that keys/secrets be rotated in the key vault and set an explicit expiration time.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.keyVault.vaults { keys.all( enabled && expires != null ) }" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          cnspec run azure -c "azure.subscription.keyVault.vaults { secrets.all( enabled == true && expires != null ) }" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.keyVault.vaults { keys.all( enabled && expires != null ) }
          azure.subscription.keyVault.vaults { secrets.all( enabled == true && expires != null ) }
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to **Key vaults**.
        3. For each Key Vault, select "Keys" or "Secrets"
        4. Make sure that each key/secret in the KV has "EXPIRATION DATE" set as appropriate
  - uid: mondoo-azure-security-ensure-the-kv-is-recoverable
    title: Ensure it is possible to recover key vaults
    impact: 80
    mql: |
      azure.subscription.keyVault.vaults {
        properties["enablePurgeProtection"] == "true"
        properties["enableSoftDelete"] == "true"
      }
    docs:
      desc: |
        Azure Key Vault can store keys, secrets, and certificates. Accidental unavailability of a Key Vault can cause serious problems in any organization.

        Soft Delete is a feature of Key Vault that retains Key Vaults and Key Vault items after initial deletion. By default, new Key Vaults created through the portal will have soft delete for 90 days configured.
        Once enabled, soft delete can not be disabled. When soft delete is enabled, it is possible to purge soft deleted vaults and vault items.

        Purge protection is another feature of Key Vaults that is used to protect deleted Key Vaults for a certain period, called the "retention period." Once enabled, purge protection prevents deleted key vaults from being purged until the retention period has been reached. This selection cannot be changed once the Key Vault is created.
        If a Key Vault is created with purge protection, you can still delete it, but you will not be able to purge it once it is deleted. In this case, the deleted Key Vaults will have to wait for 90 days to pass to be permanently purged.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.keyVault.vaults { properties["enablePurgeProtection"] == "true" properties["enableSoftDelete"] == "true" }" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.keyVault.vaults { properties["enablePurgeProtection"] == "true" properties["enableSoftDelete"] == "true" }
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to **Key vaults**.
        3. Select "Properties" and ensure Soft delete has been enabled on this key vault
        4. At the bottom of the page, select "Enable Purge Protection"
  - uid: mondoo-azure-security-ensure-logging-enabled-kv
    title: Ensure all operations on Key Vault is logged
    impact: 80
    mql: |
      azure.subscription.keyVault.vaults {
        diagnosticSettings.any( properties["logs"].where( _["category"] == "AuditEvent" && _["retentionPolicy"]["days"] >= 180 )  )
      }
    docs:
      desc: |
        Monitoring how, by whom and when kv are accessed, enables an audit trail of interactions with confidential information, keys, secrets and certificates.

        Enabling logging for Key Vault saves information in an Azure storage account which the user provides. This will create a new container called insights-logs-auditevent for the specified storage account.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.keyVault.vaults { diagnosticSettings.any( properties["logs"].where( _["category"] == "AuditEvent" && _["retentionPolicy"]["days"] >= 180 )  ) }" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.keyVault.vaults { diagnosticSettings.any( properties["logs"].where( _["category"] == "AuditEvent" && _["retentionPolicy"]["days"] >= 180 )  ) }
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to **Key vaults**.
        3. Select "Properties" and ensure Soft delete has been enabled on this key vault
        4. At the bottom of the page, select "Enable Purge Protection"
  - uid: mondoo-azure-security-ensure-activity-log-alert-exists-for-create-update-delete-network-security-group
    title: Ensure that activity log alerts exist for the commands Create, Update, and Delete Network Security Group
    impact: 80
    mql: |
      azure.subscription.monitor.activityLog.alerts.where( actions.length > 0 ).any( conditions.any( _["equals"] == "Microsoft.Network/networkSecurityGroups/write" && _["fieldName"] == "operationName" ) )
      azure.subscription.monitor.activityLog.alerts.where( actions.length > 0 ).any( conditions.any( _["equals"] == "Microsoft.Network/networkSecurityGroups/delete" && _["fieldName"] == "operationName" ) )
    docs:
      desc: |
        Monitoring Network Security Group events can give clear insight into network access changes and it is very useful for detecting suspicious activity.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.monitor.activityLog.alerts.where( actions.length > 0 ).any( conditions.any( _["equals"] == "Microsoft.Network/networkSecurityGroups/write" && _["fieldName"] == "operationName" ) )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          cnspec run azure -c "azure.subscription.monitor.activityLog.alerts.where( actions.length > 0 ).any( conditions.any( _["equals"] == "Microsoft.Network/networkSecurityGroups/delete" && _["fieldName"] == "operationName" ) )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.monitor.activityLog.alerts.where( actions.length > 0 ).any( conditions.any( _["equals"] == "Microsoft.Network/networkSecurityGroups/write" && _["fieldName"] == "operationName" ) )
          azure.subscription.monitor.activityLog.alerts.where( actions.length > 0 ).any( conditions.any( _["equals"] == "Microsoft.Network/networkSecurityGroups/delete" && _["fieldName"] == "operationName" ) )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Navigate to the "Monitor" blade
          1. Select "Alerts"
          2. Select "Create" and then "Alert rule"
          3. Under the Scope tab, select "Select scope"
          4. In the "Select a resource" window, select the appropriate filters:
            - Filter by subscription: "< choose the subscription alerts are needed for >""
            - Filter by resource location: **"Network security groups"**
            - Filter by location: "All"
            - Select the "subscription name" or "resource group" or "Network security group" that the Log Alert Rule will be applied to
          5. Verify that the selection preview shows:
            - "All network security groups" or "< your network security group >""
            - "< Resource Name >" - The subscription, group, or resource you selected
          6. Select "Done"
          7. Under the Condition tab, select "Add Condition"
          8. In the "Select a signal" window, under the "Signal Name" heading, select **`Create or Update Network Security Group (Microsoft.Network/networkSecurityGroups)`**
          9. Need to repeat the previous step also for **`Delete Network Security Group (Microsoft.Network/networkSecurityGroups)`**
          10. Under the Actions tab, choose appropriately:
            - Select action groups - If you have an existing action group to notify the necessary personnel.
            - Create action group - If you do not have an existing action group or want to create a new one.
          11. Under the Details tab, fill in:
            - Resource group - Select the resource group you want the alert rule to reside in.
            - Alert rule name - Give your alert a recognizable and standardized name.
            - Alert rule description - (Optional)
          12. Select `Review + create` then verify the summary details
          13. Select `Create`
  - uid: mondoo-azure-security-ensure-that-notify-about-alerts-with-high-severity-is-on
    title: Ensure that "Notify about alerts with high severity" is enabled
    impact: 80
    mql: |
      azure.subscription.cloudDefender.securityContacts.all( alertNotifications["minimalSeverity"] == "High" && alertNotifications["state"] == "On" )
    docs:
      desc: |
        Enabling security alert emails ensures that security alert emails are received from Microsoft.
        This ensures that Admins are aware of any potential security issues and are able to react quickly.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.cloudDefender.securityContacts.all( alertNotifications["minimalSeverity"] == "High" && alertNotifications["state"] == "On" )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.cloudDefender.securityContacts.all( alertNotifications["minimalSeverity"] == "High" && alertNotifications["state"] == "On" )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Select `Microsoft Defender for Cloud`
        3. Select `Environment Settings` and then select the appropriate Management Group, Subscription, or Workspace
        4. Select on `Email notifications` and ensure that the `Notify about alerts with the following severity (or higher)` setting is checked and set to `High`
  - uid: mondoo-azure-security-ensure-that-ssl-enabled-postgresql
    title: Ensure SSL connection enabled for PostgreSQL Database Server
    impact: 80
    mql: |
      azure.subscription.postgreSql.servers.all( properties["sslEnforcement"] == "Enabled" )
    docs:
      desc: |
        All communications between the clients and the PostgreSQL server should be through SSL/TLS to add a layer of encryption to prevent any man in the middle attacks.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.postgreSql.servers.all( properties["sslEnforcement"] == "Enabled" )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.postgreSql.servers.all( properties["sslEnforcement"] == "Enabled" )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Go to Azure Database for `PostgreSQL server`
        3. For each database, select `Connection security`
        4. In `SSL` settings, select `ENABLED` to enforce SSL connections
  - uid: mondoo-azure-security-ensure-that-ssl-enabled-latest-version-mariadb
    title: Ensure SSL connection enabled for MariaDB Database Server with the latest version
    impact: 80
    mql: |
      azure.subscription.mariaDb.servers.all( properties["sslEnforcement"] == "Enabled" )
      azure.subscription.mariaDb.servers.all( properties["minimalTlsVersion"] == "TLS1_2" )
    docs:
      desc: |
        All communications between the clients and the Mariadb server should be through SSL/TLS to add a layer of encryption to prevent any man in the middle attacks.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.mariaDb.servers.all( properties["sslEnforcement"] == "Enabled" )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.mariaDb.servers.all( properties["sslEnforcement"] == "Enabled" )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Go to Azure Database for `MariaDB server`
        3. For each database, select `Connection security`
        4. In `SSL` settings, select `ENABLED` to enforce SSL connections
        5. In TLS setting, make the latest version chosen as minimum tls version
  - uid: mondoo-azure-security-ensure-deny-public-access-mariadb
    title: Ensure Public Network access for MariaDB is disabled
    impact: 80
    mql: |
      azure.subscription.mariaDb.servers.all( properties["publicNetworkAccess"] == "Disabled" )
    docs:
      desc: |
        All public access to MariaDB should be blocked, and only connections through private endpoints should be allowed to further enhance network security.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.mariaDb.servers.all( properties["publicNetworkAccess"] == "Disabled" )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.mariaDb.servers.all( properties["publicNetworkAccess"] == "Disabled" )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Go to Azure Database for `MariaDB server`
        3. For each database, select `Connection security`
        4. In `Deny Public network access` settings, select **Yes**
  - uid: mondoo-azure-security-ensure-that-ssl-enabled-latest-version-mysql
    title: Ensure SSL connection enabled for MySQL Database Server with the latest version
    impact: 80
    mql: |
      azure.subscription.mySql.servers.all ( properties["sslEnforcement"] == "Enabled" )
      azure.subscription.mySql.servers.all ( properties["minimalTlsVersion"] == "TLS1_2" )
    docs:
      desc: |
        All communications between the clients and the MySQL server should be through SSL/TLS to add a layer of encryption to prevent any man in the middle attacks.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.mySql.servers.all ( properties["sslEnforcement"] == "Enabled" )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          cnspec run azure -c "azure.subscription.mySql.servers.all ( properties["minimalTlsVersion"] == "TLS1_2" )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.mySql.servers.all ( properties["sslEnforcement"] == "Enabled" )
          azure.subscription.mySql.servers.all ( properties["minimalTlsVersion"] == "TLS1_2" )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Go to Azure Database for `mySQL server`
        3. For each database, select `Connection security`
        4. In `SSL` settings, select `ENABLED` to enforce SSL connections
        5. At end, in TLS setting, choose the latest tls version
  - uid: mondoo-azure-security-ensure-disabled-public-access-sql
    title: Ensure Public Network access for SQL server is disabled or only possible through firewall rules
    impact: 80
    mql: |
      azure.subscription.sql.servers.all ( properties["publicNetworkAccess"] == "Disabled" || properties["publicNetworkAccess"] == "Enabled" && firewallRules.length > 0 )
    docs:
      desc: |
        Customers can choose to connect to a database by using one of the following ways:
          * public endpoints (with IP-based server-level firewall rules or with virtual-network firewall rules)
          * private endpoints (by using Azure Private Link)

        When Public network access is set to Disable, only connections from private endpoints are allowed. All connections from public endpoints will be denied.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.sql.servers.all ( properties["publicNetworkAccess"] == "Disabled" || properties["publicNetworkAccess"] == "Enabled" && firewallRules.length > 0" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.sql.servers.all ( properties["publicNetworkAccess"] == "Disabled" || properties["publicNetworkAccess"] == "Enabled" && firewallRules.length > 0 )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Go to `SQL servers`
        3. For each server, select `Networking` under Security
        4. In `Public network access` settings, select Disabled or `Selected networks` with activated Firewall rules or Virtual networks
  - uid: mondoo-azure-security-keyvault-public-access-disabled
    title: Ensure default Public Network access for Key Vault is disabled
    impact: 80
    mql: |
      azure.subscription.keyVault.vaults.all ( properties["publicNetworkAccess"] == "Disabled" )
    docs:
      desc: |
        The default Public Network Access to the Key Vault must be disabled in order to add a layer of security to one of the most important component in the Azure environment.
        By default, when you create a new key vault, the Azure Key Vault firewall is disabled. All applications and Azure services can access the key vault and send requests to the key vault. This configuration doesn't mean that any user will be able to perform operations on your key vault. The key vault still restricts access to secrets, keys, and certificates stored in key vault by requiring Azure Active Directory authentication and access policy permissions.

        To enhance network security, you can configure your vault to disable public access. This will deny all public configurations and allow only connections through private endpoints. It is also possible to allow public access from specific virtual networks and IP addresses.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.keyVault.vaults.all ( properties["publicNetworkAccess"] == "Disabled" )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.keyVault.vaults.all ( properties["publicNetworkAccess"] == "Disabled" )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Go to `Key vaults`
        3. For each key vault server, select `Networking` under Settings
        4. In `Firewalls and virtual networks` settings, select "Disable public access"
  - uid: mondoo-azure-security-sql-server-audit-on
    title: Ensure that all activities on SQL server is audited
    impact: 60
    mql: |
      azure.subscription.sql.servers.all( auditingPolicy["state"] == "Enabled" )
    docs:
      desc: |
        Auditing is a very important feature and should be configured for every database or server in your deployment in Azure.
        When server level auditing is enabled, it's enabled for all existing databases and new databases which will be created in future.

        Enable Server audit when you must audit all databases for that logical server, enable database level audit when you want audit different action groups for a specific database or write to different target for a specific database.

        If you are enabling both server and database level audit for a database, then you can choose predicate expression to filter the events to ensure you are not capturing duplicate data.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.sql.servers.all( auditingPolicy["state"] == "Enabled" )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.sql.servers.all( auditingPolicy["state"] == "Enabled" )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Go to `SQL servers`
        3. For each SQL server select `Auditing` and make sure `Enable Azure SQL Auditing` is set to `On`
  - uid: mondoo-azure-security-sql-server-tde-on
    title: Ensure that transparent data encryption is enabled on SQL Server
    impact: 60
    mql: |
      azure.subscription.sql.servers { databases.where (name != "master").all( transparentDataEncryption["state"] == "Enabled" ) }
    docs:
      desc: |
        Transparent data encryption (TDE) encrypts SQL Server, Azure SQL Database, and Azure Synapse Analytics data files. This encryption is known as encrypting data at rest.

        TDE does real-time I/O encryption and decryption of data and log files. The encryption uses a database encryption key (DEK). The database boot record stores the key for availability during recovery. The DEK is a symmetric key. It's secured by a certificate that the server's master database stores or by an asymmetric key that an EKM module protects.

        TDE protects data at rest, which is the data and log files. It lets you follow many laws, regulations, and guidelines established in various industries. This ability lets software developers encrypt data by using AES and 3DES encryption algorithms without changing existing applications.

        Note:  TDE is not available for system databases.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.sql.servers { databases.where (name != "master").all( transparentDataEncryption["state"] == "Enabled" ) }" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.sql.servers { databases.where (name != "master").all( transparentDataEncryption["state"] == "Enabled" ) }
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Go to `SQL servers`
        3. For each DB instance, select `Transparent data encryption` and make sure `Data encryption` is set to `On`
  - uid: mondoo-azure-security-diagnostic-settings-exist
    title: Ensure that diagnostic settings exist for the subscription
    impact: 80
    mql: |
      azure.subscription.monitor.diagnosticSettings.length > 0
    docs:
      desc: |
        The diagnostic settings is an important piece in the security puzzle, and it is highly recommended by Microsoft in Azure Security Center.

        To understand what exactly the "diagnostic settings" is, we need to understand the data source on Monitor component in Azure.

        Azure Monitor is based on different Logs and Metrics that we can collect from multiple resources. These data can be analyzed using a set of tools provided in Azure Monitor.
        Azure Resources generate a significant amount of monitoring data which categorized into two mondoo-azure-security-ensure-the-expiration-date-is-set-for-all-keys-and-secrets-in-kv:

         * Metrics : Numerical values that describe some aspect of a system at a particular point of time.
         * Logs  :  Provide detailed diagnostic and auditing information for Azure resources.

        The Logs itself can be categorized into two types:

         * Resource logs aren't collected until they're routed to a destination.
         * Activity logs exist on their own but can be routed to other locations.

        Each Azure resource requires its own diagnostic setting, which defines the following criteria:

         * Sources: The type of metric and log data to send to the destinations defined in the setting. The available types vary by resource type.
         * Destinations: One or more destinations to send to.


        A diagnostic setting basically controls how logs are exported. By default, logs are retained only for 90 days.
        By having the diagnostic settings, we can export the logs and store them for longer period in order to analyze the activities and find any security related issues.
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.monitor.diagnosticSettings.length > 0" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.monitor.diagnosticSettings.length > 0
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Go to `Monitor` and select `Activity Logs`
        3. Select a subscription, and make sure there is already a "diagnostic settings" for that subscription
  - uid: mondoo-azure-security-diagnostic-settings-essential-categories
    title: Ensure that Diagnostic Setting collects essential security categories
    impact: 80
    mql: |
      azure.subscription.monitor.diagnosticSettings.all( properties["logs"].where( _["enabled"] == "true" ).any( _["category"] == "Administrative" ) )
      azure.subscription.monitor.diagnosticSettings.all( properties["logs"].where( _["enabled"] == "true" ).any( _["category"] == "Security" ) )
      azure.subscription.monitor.diagnosticSettings.all( properties["logs"].where( _["enabled"] == "true" ).any( _["category"] == "Alert" )  )
    docs:
      desc: |
        Diagnostic setting controls how the diagnostic logs are exported and what type of data need to be collected and be exported to the defined destination.
        By default no log categories are selected when the Diagnostic Setting is created. Capturing the appropriate log categories for the activities performed within your subscriptions provides proper insight into the environment and will help the SOC team in analyzing.

        We recommend at minimum collect following categories:

          * Security
          * Alert
          * Administrative
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.monitor.diagnosticSettings.all( properties["logs"].where( _["enabled"] == "true" ).any( _["category"] == "Administrative" ) )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          cnspec run azure -c "azure.subscription.monitor.diagnosticSettings.all( properties["logs"].where( _["enabled"] == "true" ).any( _["category"] == "Security" ) )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          cnspec run azure -c "azure.subscription.monitor.diagnosticSettings.all( properties["logs"].where( _["enabled"] == "true" ).any( _["category"] == "Alert" )  )" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.monitor.diagnosticSettings.all( properties["logs"].where( _["enabled"] == "true" ).any( _["category"] == "Administrative" ) )
          azure.subscription.monitor.diagnosticSettings.all( properties["logs"].where( _["enabled"] == "true" ).any( _["category"] == "Security" ) )
          azure.subscription.monitor.diagnosticSettings.all( properties["logs"].where( _["enabled"] == "true" ).any( _["category"] == "Alert" )  )
          ```
      remediation: |
        ### Microsoft Azure Portal

        To update using the Microsoft Azure portal:
        1. Log in to the Microsoft Azure portal at https://portal.azure.com
        2. Go to `Monitor` and select `Activity Logs`
        3. Select a subscription, and make sure there is already a "diagnostic settings" for that subscription
  - uid: mondoo-azure-security-disable-udp-virtualmachines
    title: Ensure direct UDP access to Azure Virtual Machines from the Internet is restricted
    impact: 80
    mql: |
      azure.subscription.network.securityGroups {
        securityRules.where( properties['access'] == 'Allow' && properties['direction'] == 'Inbound' && properties['protocol'] == /UDP/ && properties['sourceAddressPrefix'] == /\*|0\.0\.0\.0|<nw>\/0|\/0|internet|any/ )
        } {
          securityRules {
            properties["destinationPortRange"] != "*"
            properties["destinationPortRange"] != "53"
            properties["destinationPortRange"] != "123"
            properties["destinationPortRange"] != "161"
            properties["destinationPortRange"] != "389"
            properties["destinationPortRange"] != "1900"
            if (properties["destinationPortRange"].split("-").length > 1) {
              a = properties["destinationPortRange"].split("-")[0] < 53 && properties["destinationPortRange"].split("-")[1] < 53
              b = properties["destinationPortRange"].split("-")[0] > 53 && properties["destinationPortRange"].split("-")[1] > 53
              a || b
            }
            if (properties["destinationPortRange"].split("-").length > 1) {
              a = properties["destinationPortRange"].split("-")[0] < 123 && properties["destinationPortRange"].split("-")[1] < 123
              b = properties["destinationPortRange"].split("-")[0] > 123 && properties["destinationPortRange"].split("-")[1] > 123
              a || b
            }
            if (properties["destinationPortRange"].split("-").length > 1) {
              a = properties["destinationPortRange"].split("-")[0] < 161 && properties["destinationPortRange"].split("-")[1] < 161
              b = properties["destinationPortRange"].split("-")[0] > 161 && properties["destinationPortRange"].split("-")[1] > 161
              a || b
            }
            if (properties["destinationPortRange"].split("-").length > 1) {
              a = properties["destinationPortRange"].split("-")[0] < 389 && properties["destinationPortRange"].split("-")[1] < 389
              b = properties["destinationPortRange"].split("-")[0] > 389 && properties["destinationPortRange"].split("-")[1] > 389
              a || b
            }
            if (properties["destinationPortRange"].split("-").length > 1) {
              a = properties["destinationPortRange"].split("-")[0] < 1900 && properties["destinationPortRange"].split("-")[1] < 1900
              b = properties["destinationPortRange"].split("-")[0] > 1900 && properties["destinationPortRange"].split("-")[1] > 1900
              a || b
            }
            properties["destinationPortRanges"].all(_ != 53 )
            properties["destinationPortRanges"].all(_ != 123 )
            properties["destinationPortRanges"].all(_ != 161 )
            properties["destinationPortRanges"].all(_ != 389 )
            properties["destinationPortRanges"].all(_ != 1900 )
        }
      }
    docs:
      desc: |
        The main security issue with exposing UDP services over the Internet is the broad attack surface that allows attackers to use Reflection Amplification Attack against Virtual Machines.

        A reflection attack involves an attacker spoofing a target's IP address and sending a request for information, mainly using UDP. The server then responds by sending an answer. This is called "reflection" (using the same protocol in both directions) attack.
        The main issue is related to the way UDP protocol has been designed. UDP is a connection-less protocol that does not validate source IP addresses. Unless the application layer protocol uses countermeasures, an attacker can easily forge the IP packet datagram to include an arbitrary source IP address.
        When many UDP packets have their source IP address forged to the victim IP address, the destination server (or amplifier) responds to the victim (instead of the attacker), creating a reflected denial-of-service (DoS) attack.

        Any server having Open UDP ports can be targeted as a reflector. One way of protecting against this attack is to make sure well known UDP port services are not disclosed to the internet.

        Some application-layer protocols that rely on the UDP can be seen here:

          * Domain Name System (DNS)
          * Network Time Protocol (NTP)
          * Connection-less Lightweight Directory Access Protocol (CLDAP)
          * Character Generator Protocol (CharGEN)
          * Simple Service Discovery Protocol (SSDP)
          * BitTorrent
          * Simple Network Management Protocol version 2 (SNMPv2)
          * Portmap/Remote Procedure Call (RPC)
          * Network Basic Input/Output System (NetBIOS)
          * Trivial File Transfer Protocol (TFTP)
      audit: |
        __cnspec run__

        To audit Microsoft Azure with `cnspec run`:

        Note: It is also possible to use a client secret for app connection instead of a certificate.

        Run this query:

          ```bash
          cnspec run azure -c "azure.subscription.network.securityGroups {
          securityRules.where( properties['access'] == 'Allow' && properties['direction'] == 'Inbound' && properties['protocol'] == /UDP/ && properties['sourceAddressPrefix'] == /\*|0\.0\.0\.0|<nw>\/0|\/0|internet|any/ )
          } {
            securityRules {
              properties["destinationPortRange"] != "*"
              properties["destinationPortRange"] != "53"
              properties["destinationPortRange"] != "123"
              properties["destinationPortRange"] != "161"
              properties["destinationPortRange"] != "389"
              properties["destinationPortRange"] != "1900"
              if (properties["destinationPortRange"].split("-").length > 1) {
                a = properties["destinationPortRange"].split("-")[0] < 53 && properties["destinationPortRange"].split("-")[1] < 53
                b = properties["destinationPortRange"].split("-")[0] > 53 && properties["destinationPortRange"].split("-")[1] > 53
                a || b
              }
              if (properties["destinationPortRange"].split("-").length > 1) {
                a = properties["destinationPortRange"].split("-")[0] < 123 && properties["destinationPortRange"].split("-")[1] < 123
                b = properties["destinationPortRange"].split("-")[0] > 123 && properties["destinationPortRange"].split("-")[1] > 123
                a || b
              }
              if (properties["destinationPortRange"].split("-").length > 1) {
                a = properties["destinationPortRange"].split("-")[0] < 161 && properties["destinationPortRange"].split("-")[1] < 161
                b = properties["destinationPortRange"].split("-")[0] > 161 && properties["destinationPortRange"].split("-")[1] > 161
                a || b
              }
              if (properties["destinationPortRange"].split("-").length > 1) {
                a = properties["destinationPortRange"].split("-")[0] < 389 && properties["destinationPortRange"].split("-")[1] < 389
                b = properties["destinationPortRange"].split("-")[0] > 389 && properties["destinationPortRange"].split("-")[1] > 389
                a || b
              }
              if (properties["destinationPortRange"].split("-").length > 1) {
                a = properties["destinationPortRange"].split("-")[0] < 1900 && properties["destinationPortRange"].split("-")[1] < 1900
                b = properties["destinationPortRange"].split("-")[0] > 1900 && properties["destinationPortRange"].split("-")[1] > 1900
                a || b
              }
              properties["destinationPortRanges"].all(_ != 53 )
              properties["destinationPortRanges"].all(_ != 123 )
              properties["destinationPortRanges"].all(_ != 161 )
              properties["destinationPortRanges"].all(_ != 389 )
              properties["destinationPortRanges"].all(_ != 1900 )
          }
        }" --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        __cnspec shell__

        To audit Microsoft Azure with `cnspec shell`:

        1. Launch `cnspec shell`:

          ```bash
          cnspec shell azure --certificate-path <*.pem> --tenant-id <tenant_id> --client-id <client_id>
          ```

        2. Run this query:

          ```mql
          azure.subscription.network.securityGroups {
            securityRules.where( properties['access'] == 'Allow' && properties['direction'] == 'Inbound' && properties['protocol'] == /UDP/ && properties['sourceAddressPrefix'] == /\*|0\.0\.0\.0|<nw>\/0|\/0|internet|any/ )
            } {
              securityRules {
                properties["destinationPortRange"] != "*"
                properties["destinationPortRange"] != "53"
                properties["destinationPortRange"] != "123"
                properties["destinationPortRange"] != "161"
                properties["destinationPortRange"] != "389"
                properties["destinationPortRange"] != "1900"
                if (properties["destinationPortRange"].split("-").length > 1) {
                  a = properties["destinationPortRange"].split("-")[0] < 53 && properties["destinationPortRange"].split("-")[1] < 53
                  b = properties["destinationPortRange"].split("-")[0] > 53 && properties["destinationPortRange"].split("-")[1] > 53
                  a || b
                }
                if (properties["destinationPortRange"].split("-").length > 1) {
                  a = properties["destinationPortRange"].split("-")[0] < 123 && properties["destinationPortRange"].split("-")[1] < 123
                  b = properties["destinationPortRange"].split("-")[0] > 123 && properties["destinationPortRange"].split("-")[1] > 123
                  a || b
                }
                if (properties["destinationPortRange"].split("-").length > 1) {
                  a = properties["destinationPortRange"].split("-")[0] < 161 && properties["destinationPortRange"].split("-")[1] < 161
                  b = properties["destinationPortRange"].split("-")[0] > 161 && properties["destinationPortRange"].split("-")[1] > 161
                  a || b
                }
                if (properties["destinationPortRange"].split("-").length > 1) {
                  a = properties["destinationPortRange"].split("-")[0] < 389 && properties["destinationPortRange"].split("-")[1] < 389
                  b = properties["destinationPortRange"].split("-")[0] > 389 && properties["destinationPortRange"].split("-")[1] > 389
                  a || b
                }
                if (properties["destinationPortRange"].split("-").length > 1) {
                  a = properties["destinationPortRange"].split("-")[0] < 1900 && properties["destinationPortRange"].split("-")[1] < 1900
                  b = properties["destinationPortRange"].split("-")[0] > 1900 && properties["destinationPortRange"].split("-")[1] > 1900
                  a || b
                }
                properties["destinationPortRanges"].all(_ != 53 )
                properties["destinationPortRanges"].all(_ != 123 )
                properties["destinationPortRanges"].all(_ != 161 )
                properties["destinationPortRanges"].all(_ != 389 )
                properties["destinationPortRanges"].all(_ != 1900 )
            }
          }
          ```
      remediation: |
        Disable direct UDP access to your Azure Virtual Machines from the Internet. There are other options you can be used to access UDP based services running on these virtual machines:
        * Point-to-site VPN
        * Site-to-site VPN
        * ExpressRoute

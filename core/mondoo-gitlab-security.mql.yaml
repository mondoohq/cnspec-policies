owner_mrn: //policy.api.mondoo.app
policies:
  - uid: mondoo-gitlab-security
    name: GitLab Security by Mondoo
    version: 1.2.0
    is_public: true
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    docs:
      desc: |-
        The GitLab Security by Mondoo policy bundle provides guidance for establishing minimum recommended security and operational best practices for GitLab. This policy is early access.

        __Configuration__

        To scan your GitLab Organization from your workstation:

        1. Enable the GitLab Baseline by Mondoo Policy in the Policy Hub
        2. Create a [personal access token](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html).
        3. Open a terminal, `export GITLAB_TOKEN=<your personal access token>`.  
        4. Run a scan

           ```bash
           cnspec scan gitlab --option token=${GITLAB_TOKEN} --option group=<group name>
           ```      
          
        If you have questions, comments, or have identified ways to improve this policy, please write us at hello@mondoo.com, or reach out in [GitHub Discussions](https://github.com/orgs/mondoohq/discussions).
    specs:
      - asset_filter:
          query: platform.name == "gitlab"
        scoring_queries:
          mondoo-gitlab-security-private-group: null
          mondoo-gitlab-security-require-two-factor: null
          mondoo-gitlab-security-private-projects: null
queries:
  - uid: mondoo-gitlab-security-private-group
    title: Ensure the group is private
    docs: 
      desc: |
        GitLab allows users with the Owner role to set a project's or group's visibility as:

        - Public
        - Internal
        - Private

        These visibility levels affect who can see the project in the public access directory (/public for your GitLab instance). For example, https://gitlab.com/public. You can control the visibility of individual features with project feature settings.

        Private projects can only be cloned and viewed by project members (except for guests). They appear in the public access directory (`/public``) for project members only.

      audit: |
        __cnspec Shell__

        1. Open a Terminal.
        2. Connect cnspec shell to GitLab `cnspec shell gitlab --option token=${GITLAB_TOKEN} --option group=<group name>`
        3. Run the following query

           ```mql
           gitlab.group.visibility 
           ```
      remediation: |
        To make the visibility of a GitLab group private, see [Change group visibility](https://docs.gitlab.com/ee/user/public_access.html#change-group-visibility).      
    query: |
      gitlab.group.visibility != "public"
  - uid: mondoo-gitlab-security-require-two-factor
    title: Ensure two-factor authentication is required
    docs: 
      desc: |
        Two-factor authentication (2FA) provides an additional layer of security to your users' GitLab accounts. When enabled, users are prompted for a code generated by an application in addition to supplying their username and password to sign in.

      audit: |
        __cnspec Shell__

        1. Open a Terminal.
        2. Connect cnspec shell to GitLab `cnspec shell gitlab --option token=${GITLAB_TOKEN} --option group=<group name>`
        3. Run the following query

           ```mql
           gitlab.group.requireTwoFactorAuthentication 
           ```
      remediation: |
        GitLab offers several options to configure 2FA for your users. To enable MFA in your GitLab, see [Enforce two-factor authentication](https://docs.gitlab.com/ee/security/two_factor_authentication.html) on the GitLab documentation site. 
    query: |
      gitlab.group.requireTwoFactorAuthentication == true
  - uid: mondoo-gitlab-security-private-projects
    title: Ensure all projects are private
    docs: 
      desc: |
        GitLab allows users with the Owner role to set a project's or group's visibility as:

        - Public
        - Internal
        - Private

        These visibility levels affect who can see the project in the public access directory (/public for your GitLab instance). For example, https://gitlab.com/public. You can control the visibility of individual features with project feature settings.


        Private projects can only be cloned and viewed by project members (except for guests). They appear in the public access directory (`/public``) for project members only.

      audit: |
        __cnspec Shell__

        1. Open a Terminal.
        2. Connect cnspec shell to GitLab `cnspec shell gitlab --option token=${GITLAB_TOKEN} --option group=<group name>`
        3. Run the following query

           ```mql
           gitlab.group.visibility 
           ```
      remediation: |
        To make the visibility of a GitLab project private, see [Change project visibility](https://docs.gitlab.com/ee/user/public_access.html#change-project-visibility). 
    query: |
      gitlab.group.projects { visibility != "public" }